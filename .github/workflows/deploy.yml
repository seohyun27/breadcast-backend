name: Deploy to EC2 (Diagnostics Mode)

on:
  push:
    branches:
      - main
      - hotfix/settings

jobs:
  # 1. Build and Test
  build:
    runs-on: self-hosted
    # Runner의 기본 작업 디렉터리: ${GITHUB_WORKSPACE}/breadcast
    defaults:
      run:
        working-directory: breadcast

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4.1.7

      # ⭐️ [진단 단계] 이 로그를 통해 gradlew의 정확한 위치를 파악할 수 있습니다.
      - name: Debug_List Files in Working Directory
        run: |
          echo "--- Runner의 기본 작업 공간 (${GITHUB_WORKSPACE}/breadcast) 파일 목록 ---"
          # 현재 디렉터리의 파일 및 폴더 목록을 재귀적으로 출력합니다.
          ls -RF .
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew 

      - name: Setup Java environment
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build with Gradle and Test
        run: ./gradlew clean build --no-daemon
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          ACCESS_KEY: ${{ secrets.ACCESS_KEY }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: breadcast/build/libs/*.jar

  # 2. Deploy
  deploy:
    runs-on: self-hosted
    needs: build

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: ./deploy

      - name: Execute Deploy Script on EC2
        shell: /usr/bin/bash -e {0}
        run: |
          TARGET_DIR=$(pwd) 
          TARGET_PORT=8080

          echo "Current working directory for deployment: $TARGET_DIR"

          # 1) 포트 사용 프로세스 종료
          echo "Stopping old process on port $TARGET_PORT..."
          sudo fuser -k -n tcp $TARGET_PORT || true 
          sleep 5

          # 2) 새로운 JAR 파일 찾기 및 실행
          JAR_FILE=$(ls -tr ./deploy/*.jar | grep -v plain | tail -1)

          # 3) 백그라운드에서 실행
          echo "Starting new application: $JAR_FILE"
          nohup java \
            -DDB_HOST=${{ secrets.DB_HOST }} \
            -DDB_PORT=${{ secrets.DB_PORT }} \
            -DDB_NAME=${{ secrets.DB_NAME }} \
            -DDB_USERNAME=${{ secrets.DB_USERNAME }} \
            -DDB_PASSWORD=${{ secrets.DB_PASSWORD }} \
            -DACCESS_KEY=${{ secrets.ACCESS_KEY }} \
            -DSECRET_KEY=${{ secrets.SECRET_KEY }} \
            -jar $JAR_FILE > app.log 2>&1 &

          # 4) 서버 시작 대기 및 로그 출력
          sleep 15
          

          echo "=== Full Application Log ==="
          cat app.log

          echo ""
          echo "=== Process Status ==="
          if ps -p $APP_PID > /dev/null; then
            echo "✓ Application is running (PID: $APP_PID)"
          else
            echo "✗ Application has stopped"
            exit 1
          fi
