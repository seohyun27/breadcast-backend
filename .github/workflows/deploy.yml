name: Deploy on EC2 

on:
  push:
    branches:
      - main
      - hotfix/settings

jobs:
  # 1. Build and Test
  build:
    runs-on: self-hosted
    # Runnerì˜ ê¸°ë³¸ ìž‘ì—… ë””ë ‰í„°ë¦¬: ${GITHUB_WORKSPACE}/breadcast
    defaults:
      run:
        working-directory: breadcast

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4.1.7

      - name: Clean Gradle Daemon and Cache
        run: |
          echo "ðŸ§¹ Cleaning Gradle daemon and cache..."

          # Gradle daemon ì¤‘ì§€
          ./gradlew --stop 2>/dev/null || true

          # í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ
          pkill -9 -f gradle 2>/dev/null || true
          pkill -9 -f GradleWorkerMain 2>/dev/null || true

          # í”„ë¡œì íŠ¸ ë‚´ Gradle ì•„í‹°íŒ©íŠ¸ ì •ë¦¬
          rm -rf .gradle build

          # Lock íŒŒì¼ ì •ë¦¬
          find ~/.gradle -name "*.lock" -type f -delete 2>/dev/null || true

          # Gradle daemon ë””ë ‰í„°ë¦¬ ì •ë¦¬
          rm -rf ~/.gradle/daemon/* 2>/dev/null || true

          echo "âœ… Gradle cleanup completed"
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew 

      - name: Setup Java environment
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build with Gradle and Test
        run: ./gradlew clean build --no-daemon
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          ACCESS_KEY: ${{ secrets.ACCESS_KEY }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: breadcast/build/libs/*.jar

  # 2. Deploy
  deploy:
    runs-on: self-hosted
    needs: build

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: ./deploy

      - name: Deploy with systemd
        run: |
          DEPLOY_DIR="/home/ubuntu/breadcast-app"
          TARGET_PORT=8080
          
          echo "=========================================="
          echo "  BreadCast Deployment Started"
          echo "=========================================="
          
          # 1. ë°°í¬ ë””ë ‰í„°ë¦¬ í™•ì¸
          mkdir -p "$DEPLOY_DIR"
          
          # 2. JAR íŒŒì¼ ì°¾ê¸° ë° ë³µì‚¬
          JAR_FILE=$(ls -t ./deploy/*.jar | grep -v plain | head -1)
          
          if [ -z "$JAR_FILE" ]; then
            echo "âŒ Error: No JAR file found in ./deploy/"
            ls -la ./deploy/
            exit 1
          fi
          
          echo "ðŸ“¦ Found JAR: $(basename $JAR_FILE)"
          echo "ðŸ“‚ Copying to: $DEPLOY_DIR/app.jar"
          
          sudo cp "$JAR_FILE" "$DEPLOY_DIR/app.jar"
          sudo chown ubuntu:ubuntu "$DEPLOY_DIR/app.jar"
          
          echo "âœ… JAR file deployed"
          
          # 3. ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
          echo ""
          echo "ðŸ”„ Restarting breadcast service..."
          sudo systemctl restart breadcast
          
          # 4. ì„œë¹„ìŠ¤ê°€ active ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          echo "â³ Waiting for service to become active..."
          for i in {1..10}; do
            if sudo systemctl is-active --quiet breadcast; then
              echo "âœ… Service is active!"
              break
            fi
            sleep 1
            echo "   Checking service... ($i/10)"
          done
          
          # 5. í¬íŠ¸ê°€ ì—´ë¦´ ë•Œê¹Œì§€ ëŒ€ê¸° (ìµœëŒ€ 40ì´ˆ)
          echo ""
          echo "â³ Waiting for application to listen on port $TARGET_PORT..."
          PORT_OPEN=false
          for i in {1..40}; do
            if sudo lsof -i :$TARGET_PORT >/dev/null 2>&1; then
              echo "âœ… Port $TARGET_PORT is now listening!"
              PORT_OPEN=true
              break
            fi
            sleep 1
            printf "."
          done
          echo ""
          
          # 6. ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          echo ""
          echo "=========================================="
          echo "  Service Status"
          echo "=========================================="
          sudo systemctl status breadcast --no-pager -l
          
          # 7. í¬íŠ¸ í™•ì¸ ê²°ê³¼
          echo ""
          echo "=========================================="
          echo "  Port Status"
          echo "=========================================="
          
          if [ "$PORT_OPEN" = true ]; then
            sudo lsof -i :$TARGET_PORT
            echo ""
            echo "âœ… Application is listening on port $TARGET_PORT"
          else
            echo "âŒ Application is NOT listening on port $TARGET_PORT after 40 seconds"
            echo ""
            echo "=== Checking if service is still running ==="
            if sudo systemctl is-active --quiet breadcast; then
              echo "âš ï¸  Service is active but port not open yet - may need more time"
              echo "Check logs with: sudo journalctl -u breadcast -f"
            else
              echo "âŒ Service has failed"
            fi
            echo ""
            echo "=== Recent Application Logs ==="
            if [ -f "$DEPLOY_DIR/app.log" ]; then
              tail -n 100 "$DEPLOY_DIR/app.log"
            else
              echo "No app.log file found"
            fi
            echo ""
            echo "=== Recent Service Logs ==="
            sudo journalctl -u breadcast -n 100 --no-pager
            exit 1
          fi
          
          # 8. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ ë¯¸ë¦¬ë³´ê¸°
          echo ""
          echo "=========================================="
          echo "  Application Log (Last 30 lines)"
          echo "=========================================="
          if [ -f "$DEPLOY_DIR/app.log" ]; then
            tail -n 30 "$DEPLOY_DIR/app.log"
          else
            echo "âš ï¸  Log file not created yet"
          fi
          
          # 9. ìµœì¢… ë©”ì‹œì§€
          echo ""
          echo "=========================================="
          echo "  âœ… Deployment Successful!"
          echo "=========================================="
          PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null || echo "unknown")
          if [ "$PUBLIC_IP" != "unknown" ]; then
            echo "Application URL: http://$PUBLIC_IP:$TARGET_PORT"
          fi
          echo ""
          echo "Useful commands:"
          echo "  - Check status: sudo systemctl status breadcast"
          echo "  - View service logs: sudo journalctl -u breadcast -f"
          echo "  - View app logs: tail -f $DEPLOY_DIR/app.log"
          echo "  - Restart: sudo systemctl restart breadcast"
          echo "=========================================="
