name: Deploy to EC2 (Optimized Single Job)

on:
  push:
    branches:
      - main

jobs:
  deploy: # 빌드, 테스트, 배포를 하나의 Job으로 통합하여 효율성을 높였습니다.
    runs-on: self-hosted
    # 모든 스크립트가 'breadcast' 폴더 내에서 실행되도록 작업 디렉터리를 설정합니다.
    defaults:
      run:
        working-directory: breadcast

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4.1.7
        with:
          # 코드가 저장된 하위 디렉터리를 Runner의 작업 디렉터리로 설정합니다.
          path: breadcast 

      - name: Grant execute permission for gradlew
        # gradlew 파일에 실행 권한을 부여합니다.
        run: chmod +x gradlew

      - name: Setup Java environment
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 1. Build and Test
      - name: Build with Gradle and Test
        # 현재 작업 디렉터리(breadcast)에서 빌드 실행
        run: ./gradlew clean build --no-daemon

      # 2. Deploy (Self-hosted Runner의 로컬 실행)
      - name: Execute Deploy Script on EC2 (Local Execution)
        shell: /usr/bin/bash -e {0}
        run: |
          # Runner의 현재 작업 디렉터리 경로를 대상 디렉터리로 설정합니다.
          TARGET_DIR=$(pwd) 
          TARGET_PORT=8080

          echo "Current working directory: $TARGET_DIR"

          # 1) 포트 사용 프로세스 종료
          echo "Stopping old process on port $TARGET_PORT..."
          # 8080 포트를 사용하는 프로세스를 강제 종료합니다.
          sudo fuser -k -n tcp $TARGET_PORT || true 
          sleep 5 # 프로세스 종료 대기

          # 2) 새로운 JAR 파일 찾기 및 실행
          # build/libs/에서 가장 최근 빌드된 JAR 파일을 찾습니다.
          JAR_FILE=$(ls -tr build/libs/*.jar | tail -1)

          # 3) 백그라운드에서 실행
          echo "Starting new application: $JAR_FILE"
          # nohup을 사용하여 백그라운드에서 실행하고 로그를 app.log에 기록합니다.
          nohup java -jar $JAR_FILE > app.log 2>&1 &

          # 4) 서버 시작 대기 및 로그 출력
          sleep 15
          echo "Application logs (Last 30 lines):"
          tail -n 30 app.log
