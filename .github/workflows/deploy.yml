name: Deploy to EC2 (Diagnostics Mode)

on:
  push:
    branches:
      - main
      - hotfix/settings

jobs:
  # 1. Build and Test
  build:
    runs-on: self-hosted
    # Runner의 기본 작업 디렉터리: ${GITHUB_WORKSPACE}/breadcast
    defaults:
      run:
        working-directory: breadcast

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4.1.7

      # ⭐️ [진단 단계] 이 로그를 통해 gradlew의 정확한 위치를 파악할 수 있습니다.
      - name: Debug_List Files in Working Directory
        run: |
          echo "--- Runner의 기본 작업 공간 (${GITHUB_WORKSPACE}/breadcast) 파일 목록 ---"
          # 현재 디렉터리의 파일 및 폴더 목록을 재귀적으로 출력합니다.
          ls -RF .
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew 

      - name: Setup Java environment
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build with Gradle and Test
        run: ./gradlew clean build --no-daemon
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          ACCESS_KEY: ${{ secrets.ACCESS_KEY }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: breadcast/build/libs/*.jar

  # 2. Deploy
  deploy:
    runs-on: self-hosted
    needs: build

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: ./deploy

      - name: Deploy with systemd
        run: |
          DEPLOY_DIR="/home/ubuntu/breadcast-app"
          TARGET_PORT=8080

          echo "=== Starting Deployment ==="

          # 1) 배포 디렉터리 확인
          mkdir -p "$DEPLOY_DIR"

          # 2) 새로운 JAR 파일 찾기 및 실행
          JAR_FILE=$(ls -tr ./deploy/*.jar | grep -v plain | tail -1)

          echo "Deploying JAR: $JAR_FILE"
          sudo cp "$JAR_FILE" "$DEPLOY_DIR/app.jar"
          sudo chown ubuntu:ubuntu "$DEPLOY_DIR/app.jar"

          # 3) systemd 재시작
          sudo systemctl restart breadcast

          # 4) 시작 대기
          echo "Waiting for application to start..."
          for i in {1..30}; do
            sleep 1
            if sudo systemctl is-active --quiet breadcast; then
              echo "✅ Service is active!"
              break
            fi
            echo "   Waiting... ($i/30)"
          done

          # 5) 서비스 상태 확인
          echo ""
          echo "=========================================="
          echo "  Service Status"
          echo "=========================================="
          sudo systemctl status breadcast --no-pager -l
          
          # 6) 포트 확인
          echo ""
          echo "=========================================="
          echo "  Port Status"
          echo "=========================================="
          
          sleep 5  # 포트가 열릴 시간 추가 대기
          
          if sudo lsof -i :$TARGET_PORT; then
            echo ""
            echo "✅ Application is listening on port $TARGET_PORT"
          else
            echo ""
            echo "❌ Application is NOT listening on port $TARGET_PORT"
            echo ""
            echo "=== Recent Service Logs ==="
            sudo journalctl -u breadcast -n 50 --no-pager
            exit 1
          fi
          
          # 7) 애플리케이션 로그 미리보기
          echo ""
          echo "=========================================="
          echo "  Application Log (Last 20 lines)"
          echo "=========================================="
          if [ -f "$DEPLOY_DIR/app.log" ]; then
            tail -n 20 "$DEPLOY_DIR/app.log"
          else
            echo "⚠️  Log file not created yet"
          fi
          
          # 8) 최종 메시지
          echo ""
          echo "=========================================="
          echo "  ✅ Deployment Successful!"
          echo "=========================================="
          echo "Application URL: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4):$TARGET_PORT"
          echo ""
          echo "Useful commands:"
          echo "  - Check status: sudo systemctl status breadcast"
          echo "  - View logs: sudo journalctl -u breadcast -f"
          echo "  - App logs: tail -f $DEPLOY_DIR/app.log"
          echo "  - Restart: sudo systemctl restart breadcast"
          echo "=========================================="

