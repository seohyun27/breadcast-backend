name: Deploy to EC2 (Diagnostics Mode)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    # Runner의 기본 작업 디렉터리: ${GITHUB_WORKSPACE}/breadcast
    defaults:
      run:
        working-directory: breadcast

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4.1.7

      # ⭐️ [진단 단계] 이 로그를 통해 gradlew의 정확한 위치를 파악할 수 있습니다.
      - name: Debug_List Files in Working Directory
        run: |
          echo "--- Runner의 기본 작업 공간 (${GITHUB_WORKSPACE}) 파일 목록 ---"
          # 현재 디렉터리의 파일 및 폴더 목록을 재귀적으로 출력합니다.
          ls -RF .
          echo "--- 'breadcast' 하위 디렉터리 내부 파일 목록 ---"
          # breadcast 폴더 내부 파일 목록을 출력합니다.
          ls -RF breadcast/
          
      - name: Grant execute permission for gradlew
        # 현재까지의 가정에 따라 'breadcast/' 폴더 내부에 gradlew가 있다고 가정하고 실행합니다.
        run: chmod +x breadcast/gradlew 

      - name: Setup Java environment
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 1. Build and Test
      - name: Build with Gradle and Test
        # 명시적인 경로를 사용하여 gradlew를 실행합니다.
        run: ./breadcast/gradlew clean build --no-daemon

      # 2. Deploy (Self-hosted Runner의 로컬 실행)
      - name: Execute Deploy Script on EC2 (Local Execution)
        shell: /usr/bin/bash -e {0}
        run: |
          # 배포 전에 실제 코드가 있는 디렉터리로 이동합니다.
          cd breadcast || exit 1 
          
          TARGET_DIR=$(pwd) 
          TARGET_PORT=8080

          echo "Current working directory for deployment: $TARGET_DIR"

          # 1) 포트 사용 프로세스 종료
          echo "Stopping old process on port $TARGET_PORT..."
          sudo fuser -k -n tcp $TARGET_PORT || true 
          sleep 5

          # 2) 새로운 JAR 파일 찾기 및 실행
          JAR_FILE=$(ls -tr build/libs/*.jar | tail -1)

          # 3) 백그라운드에서 실행
          echo "Starting new application: $JAR_FILE"
          nohup java -jar $JAR_FILE > app.log 2>&1 &

          # 4) 서버 시작 대기 및 로그 출력
          sleep 15
          echo "Application logs (Last 30 lines):"
          tail -n 30 app.log
