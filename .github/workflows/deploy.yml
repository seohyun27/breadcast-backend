name: Deploy to my server

on:
  push:
    branches: [ "main" ] # main 브랜치에 코드를 올릴 때마다 실행

jobs:
  build-and-deploy:
    runs-on: self-hosted # [중요] 내 서버(Runner)에서 실행해라!

    defaults:
      run:
        working-directory: ./breadcast

    steps:
    # 1. 코드 가져오기
    - uses: actions/checkout@v3

    # 2. 자바 설치 (프로젝트 버전에 맞춰 17 또는 11로 수정)
    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'

    # 3. 빌드 권한 부여 및 빌드
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build with Gradle
      run: ./gradlew build -x test

    # 4. 기존 서버 종료 & 새 서버 실행
    - name: Restart Spring Boot
      run: |
        # 8080 포트 쓰고 있는 프로세스 찾아서 죽이기
        pid=$(lsof -t -i:8080) || true
        if [ ! -z "$pid" ]; then
          echo "Stopping process $pid..."
          kill -9 $pid
        else
          echo "No process running on port 8080."
        fi
        
        # 잠시 대기
        sleep 2
        
        # [핵심 수정] RUNNER_TRACKING_ID="" 를 붙여서 러너가 프로세스를 죽이지 못하게 함
        echo "Starting new application..."
        RUNNER_TRACKING_ID="" nohup java -jar build/libs/*SNAPSHOT.jar > nohup.out 2>&1 &
